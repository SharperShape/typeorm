{"version":3,"sources":["../browser/src/observer/QueryObserver.ts"],"names":[],"mappings":"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","file":"QueryObserver.js","sourcesContent":["import {FindOptions, FindOptionsWhere} from \"../find-options/FindOptions\";\nimport {\n    Connection,\n    EntityMetadata,\n    EntitySubscriberInterface,\n    InsertEvent,\n    ObjectLiteral,\n    RemoveEvent,\n    UpdateEvent,\n    EntityTarget\n} from \"../index\";\nimport { Observable, ZenObservable } from \"zen-observable-ts\";\nimport SubscriptionObserver = ZenObservable.SubscriptionObserver;\n\n// todo: we probably need operation-level subscribers\n// todo: right now if we save 1000 entities within a single save call its going to call this code 1000 times\n// todo: which is not efficient\n\n/**\n * Entity manager supposed to work with any entity, automatically find its repository and call its methods,\n * whatever entity type are you passing.\n */\nexport class QueryObserver {\n\n    // -------------------------------------------------------------------------\n    // Public Properties\n    // -------------------------------------------------------------------------\n\n    insertEvents: InsertEvent<any>[] = [];\n    updateEvents: UpdateEvent<any>[] = [];\n    removeEvents: RemoveEvent<any>[] = [];\n\n    // -------------------------------------------------------------------------\n    // Private Properties\n    // -------------------------------------------------------------------------\n\n    public isSubscriberActive: boolean = false;\n    public lastEmitEntities: ObjectLiteral[] = [];\n    public lastEmitEntity: ObjectLiteral|undefined;\n    public lastEmitCount: number;\n    public subscriptionObserver: SubscriptionObserver<any>;\n\n    // -------------------------------------------------------------------------\n    // Constructor\n    // -------------------------------------------------------------------------\n\n    constructor(\n        public connection: Connection,\n        public type: \"find\"|\"findOne\"|\"findAndCount\"|\"count\",\n        public metadata: EntityMetadata,\n        public options?: FindOptions<any>|FindOptionsWhere<any>,\n    ) {\n    }\n\n    // -------------------------------------------------------------------------\n    // Public Methods\n    // -------------------------------------------------------------------------\n\n    /**\n     * Finds entities that match given options and returns observable.\n     * Whenever new data appears that matches given query observable emits new value.\n     */\n    observe(): Observable<any> {\n        this.connection.observers.push(this);\n        return new Observable(subscriptionObserver => {\n            this.subscriptionObserver = subscriptionObserver;\n            this.isSubscriberActive = true;\n\n            // we find entities matching our query\n            switch (this.type) {\n                case \"find\":\n                    this.connection.manager.find(this.metadata.target as EntityTarget<any>, this.options as any).then(entities => {\n                        subscriptionObserver.next(entities);\n                        this.lastEmitEntities = entities;\n                        this.connection.subscribers.push(this.subscriber);\n                    });\n                    break;\n\n                case \"findOne\":\n                    this.connection.manager.findOne(this.metadata.target as EntityTarget<any>, this.options as any).then(entity => {\n                        subscriptionObserver.next(entity);\n                        this.lastEmitEntity = entity;\n                        this.connection.subscribers.push(this.subscriber);\n                    });\n                    break;\n\n                case \"findAndCount\":\n                    this.connection.manager.findAndCount(this.metadata.target as EntityTarget<any>, this.options as any).then(([entities, count]) => {\n                        subscriptionObserver.next([entities, count]);\n                        this.lastEmitCount = count;\n                        this.lastEmitEntities = entities;\n                        this.connection.subscribers.push(this.subscriber);\n                    });\n                    break;\n\n                case \"count\":\n                    this.connection.manager.count(this.metadata.target as EntityTarget<any>, this.options as any, { observers: false }).then(count => {\n                        subscriptionObserver.next(count);\n                        this.lastEmitCount = count;\n                        this.connection.subscribers.push(this.subscriber);\n                    });\n                    break;\n            }\n\n            // remove subscription on cancellation\n            return () => {\n\n                // remove registered subscriber\n                if (this.subscriber) {\n                    const index = this.connection.subscribers.indexOf(this.subscriber);\n                    if (index !== -1)\n                        this.connection.subscribers.splice(index, 1);\n                }\n\n                // remove registered observer\n                const index = this.connection.observers.indexOf(this);\n                if (index !== -1)\n                    this.connection.observers.splice(index, 1);\n            };\n        });\n    }\n\n    // -------------------------------------------------------------------------\n    // Private Properties\n    // -------------------------------------------------------------------------\n\n    private subscriber: EntitySubscriberInterface<any> = {\n        listenTo: () => {\n            return this.metadata.target;\n        },\n        afterInsert: (event: InsertEvent<any>) => {\n            if (!this.subscriptionObserver || !this.isSubscriberActive)\n                return;\n\n            this.insertEvents.push(event);\n        },\n        afterUpdate: event => {\n            if (!this.subscriptionObserver || !this.isSubscriberActive)\n                return;\n\n            this.updateEvents.push(event);\n        },\n        afterRemove: event => {\n            if (!this.subscriptionObserver || !this.isSubscriberActive)\n                return;\n\n            this.removeEvents.push(event);\n        }\n    };\n\n}\n"],"sourceRoot":".."}